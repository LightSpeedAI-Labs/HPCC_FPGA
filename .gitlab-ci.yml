stages:
    - build
    - test

###
#
# Build all benchmarks
#
###

build:STREAM:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../STREAM -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make all
  artifacts:
    paths:
      - build/bin/stream_kernels_single_emulate.aocx
      - build/bin/stream_kernels_emulate.aocx
      - build/bin/STREAM_FPGA_intel
      - build/bin/Test_intel
      
      
build:RandomAccess:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../RandomAccess -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make all
  artifacts:
    paths:
      - build/bin/random_access_kernels_single_emulate.aocx
      - build/bin/RandomAccess_intel
      - build/bin/Test_intel


build:PTRANS:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../PTRANS -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make all
  artifacts:
    paths:
      - build/bin/transpose_optimized_emulate.aocx
      - build/bin/transpose_default_emulate.aocx
      - build/bin/trans_intel
      - build/bin/Test_intel

build:LINPACK:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../LINPACK -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0 -DBLOCK_SIZE=32
    - make all
  artifacts:
    paths:
      - build/bin/lu_blocked_pvt_emulate.aocx
      - build/bin/lu_blocked_pvt_test_emulate.aocx
      - build/bin/LINPACK_intel
      - build/bin/Test_intel

build:GEMM:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../GEMM -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0 -DBLOCK_SIZE=32
    - make all
  artifacts:
    paths:
      - build/bin/gemm_cannon_emulate.aocx
      - build/bin/fgemm
      - build/bin/Google_Tests_run

build:FFT:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../FFT -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make all
  artifacts:
    paths:
      - build/bin/fft1d_float_8_emulate.aocx
      - build/bin/fFFT
      - build/bin/Google_Tests_run

build:b_eff:
  stage: build
  script:
    - git submodule update --init --recursive
    - rm -rf build
    - mkdir -p build
    - cd build
    - cmake ../b_eff -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make all
  artifacts:
    paths:
      - build/bin/communication_bw520n_emulate.aocx
      - build/bin/fnet
      - build/bin/Google_Tests_run

###
#
# Execute tests for all benchmarks
#
###

test:STREAM:
  stage: test
  script:
    - cd build
    - cmake ../STREAM -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:STREAM
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log
    
test:RandomAccess:
  stage: test
  script:
    - cd build
    - cmake ../RandomAccess -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:RandomAccess
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log

test:PTRANS:
  stage: test
  script:
    - cd build
    - cmake ../PTRANS -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:PTRANS
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log

test:LINPACK:
  stage: test
  script:
    - cd build
    - cmake ../LINPACK -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:LINPACK
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log

test:GEMM:
  stage: test
  script:
    - cd build
    - cmake ../GEMM -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:GEMM
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log

test:FFT:
  stage: test
  script:
    - cd build
    - cmake ../FFT -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:FFT
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log

test:b_eff:
  stage: test
  script:
    - cd build
    - cmake ../b_eff -DDEFAULT_PLATFORM=0 -DDEFAULT_DEVICE=0
    - cd bin
    - touch kernel_output_ch0
    - touch kernel_output_ch1
    - touch kernel_output_ch2
    - touch kernel_output_ch3
    - ln -s kernel_output_ch0 kernel_input_ch1
    - ln -s kernel_output_ch2 kernel_input_ch3
    - ln -s kernel_output_ch1 kernel_input_ch0
    - ln -s kernel_output_ch3 kernel_input_ch2
    - cd ..
    - make CL_CONTEXT_EMULATOR_DEVICE_INTELFPGA=1 CTEST_OUTPUT_ON_FAILURE=1 test
  dependencies:
    - build:b_eff
  artifacts:
    when: on_failure
    paths:
      - build/Testing/Temporary/LastTest.log


